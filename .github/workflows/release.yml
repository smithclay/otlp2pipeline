name: Release

on:
  push:
    tags: ["v*"]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  # Run all CI checks first
  ci:
    uses: ./.github/workflows/ci.yml

  # Full WASM build with worker-build
  wasm-build:
    name: WASM Build
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
        with:
          cache-targets: "false"
      - name: Install WASM target
        run: rustup target add wasm32-unknown-unknown
      - name: Install worker-build
        run: cargo install worker-build
      - name: Build worker
        run: worker-build --release
      - name: Install wasm-opt
        run: |
          curl -L https://github.com/WebAssembly/binaryen/releases/download/version_118/binaryen-version_118-x86_64-linux.tar.gz | tar xzf -
          sudo mv binaryen-version_118/bin/wasm-opt /usr/local/bin/
      - name: Optimize WASM
        run: |
          wasm-opt -Os -o build/index_bg.wasm.opt build/index_bg.wasm
          mv build/index_bg.wasm.opt build/index_bg.wasm
      - name: Check WASM bundle size
        run: |
          WASM_SIZE=$(stat -c%s build/index_bg.wasm)
          echo "WASM bundle size: $((WASM_SIZE / 1024)) KB"
          # Fail if over 5MB (Cloudflare Workers limit is 10MB)
          if [ "$WASM_SIZE" -gt 5242880 ]; then
            echo "::error::WASM bundle exceeds 5MB limit"
            exit 1
          fi
      - name: Package worker
        run: |
          cd build
          zip -r ../otlp2pipeline-worker.zip worker/shim.mjs index.js index_bg.wasm
      - name: Upload worker artifact
        uses: actions/upload-artifact@v4
        with:
          name: worker-zip
          path: otlp2pipeline-worker.zip

  # Lambda ARM64 build
  lambda-build:
    name: Lambda ARM64 Build
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
        with:
          cache-targets: "false"
      - name: Install cargo-lambda
        run: pip3 install cargo-lambda
      - name: Build Lambda (ARM64)
        run: cargo lambda build --release --arm64 --features lambda --bin lambda
      - name: Rename artifact
        run: |
          mv target/lambda/lambda/bootstrap.zip otlp2pipeline-lambda-arm64.zip
      - name: Generate checksum
        run: sha256sum otlp2pipeline-lambda-arm64.zip | cut -d' ' -f1 > otlp2pipeline-lambda-arm64.zip.sha256
      - name: Upload Lambda artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-zip
          path: |
            otlp2pipeline-lambda-arm64.zip
            otlp2pipeline-lambda-arm64.zip.sha256

  # Deploy check (validates wrangler config)
  deploy-check:
    name: Deploy Check
    runs-on: ubuntu-latest
    needs: wasm-build
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
        with:
          cache-targets: "false"
      - name: Install WASM target
        run: rustup target add wasm32-unknown-unknown
      - name: Install wrangler
        run: npm install -g wrangler
      - name: Validate wrangler config
        run: npx wrangler deploy --dry-run

  # Create GitHub Release with worker artifact
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [deploy-check, lambda-build]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Download worker artifact
        uses: actions/download-artifact@v4
        with:
          name: worker-zip
      - name: Download Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-zip
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            otlp2pipeline-worker.zip \
            otlp2pipeline-lambda-arm64.zip \
            otlp2pipeline-lambda-arm64.zip.sha256
